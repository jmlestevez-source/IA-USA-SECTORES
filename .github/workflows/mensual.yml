name: Inercia-Mensual

on:
  schedule:
    # GitHub NO soporta 'L', ejecutamos dÃ­as 28-31 y validamos en Python
    - cron: '0 22 28-31 * *'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Ejecutar aunque no sea Ãºltimo dÃ­a del mes'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Verificar si es Ãºltimo dÃ­a del mes
        id: check_date
        run: |
          # Verificar si hoy es el Ãºltimo dÃ­a del mes
          TODAY=$(date +%d)
          LAST_DAY=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%d)
          
          echo "ðŸ“… Hoy: dÃ­a $TODAY"
          echo "ðŸ“… Ãšltimo dÃ­a del mes: $LAST_DAY"
          
          if [ "$TODAY" == "$LAST_DAY" ]; then
            echo "is_last_day=true" >> $GITHUB_OUTPUT
          else
            echo "is_last_day=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Inercia Mensual
        if: |
          github.event_name == 'workflow_dispatch' && inputs.force_run == 'true' ||
          github.event_name == 'workflow_dispatch' && steps.check_date.outputs.is_last_day == 'true' ||
          github.event_name == 'schedule' && steps.check_date.outputs.is_last_day == 'true'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python << 'EOF'
          import asyncio
          from inercia import calcular_inercia_mensual
          from telegram_bot import send_results

          async def main():
              print("ðŸ”„ Calculando inercia mensual...")
              resultado = calcular_inercia_mensual()
              print(f"ðŸ“Š Resultado: {resultado}")
              
              print("ðŸ“¤ Enviando resultados por Telegram...")
              await send_results()
              print("âœ… Completado!")

          asyncio.run(main())
          EOF

      - name: Skip notification
        if: |
          github.event_name == 'schedule' && steps.check_date.outputs.is_last_day == 'false'
        run: |
          echo "â­ï¸ No es el Ãºltimo dÃ­a del mes, saltando ejecuciÃ³n..."
          echo "   Esto es normal, se ejecuta dÃ­as 28-31 pero solo actÃºa el Ãºltimo."
